<?xml version="1.0" encoding="utf-8"?>
<odoo>

<!-- Set original template for tracks / track as tracking visitors -->
<record model="ir.ui.view" id="website_event_track.tracks">
    <field name="track" eval="True"/>
</record>
<record model="ir.ui.view" id="website_event_track.track_view">
    <field name="track" eval="True"/>
</record>

<!-- Add wishlist button on tracks / track templates -->
<template id="tracks_wishlist"
    name="Wishlist on Tracks"
    inherit_id="website_event_track.tracks"
    customize_show="True">
    <xpath expr="//h3" position="replace">
        <h3 class="mt0 mb0 d-flex">
            <a t-attf-href="/event/#{ slug(event) }/track/#{ slug(track) }" class="text-secondary"><span t-field="track.name"> </span></a>
            <small t-if="not track.website_published" class="badge badge-danger">unpublished</small>
            <t t-call="website_event_track_online.track_widget_reminder"/>
        </h3>
    </xpath>
</template>

<template id="track_view_wishlist"
    name="Wishlist on Track"
    inherit_id="website_event_track.track_view"
    customize_show="True">
    <xpath expr="//h1" position="replace">
        <div class="d-flex">
            <h1 t-field="track.name"/>
            <div class="ml-2 pt-1">
                <t t-call="website_event_track_online.track_widget_reminder"/>
            </div>
        </div>
    </xpath>
</template>

<!-- Revamped agenda : Will need to replace agenda_online from website_event_track in master -->
<template id="agenda_online" name="Track Online: Agenda">
    <t t-call="website_event.layout">
        <div class="oe_structure" id="oe_structure_website_event_track_agenda_1"/>
        <section class="container pt48">
            <h1 t-field="event.name"/>
            <div class="form-inline float-right">
                <label class="invisible text-muted mr-2" id="search_summary"><span id="search_number" class="mr-1">0</span>Results</label>
                <input type="text" class="form-control" placeholder="Filter Tracks..." id="event_track_search"/>
            </div>
        </section>

        <section t-if="not event.track_ids" class="container">
            <h3>No track found.</h3>
            <div t-if="user_event_manager" class="alert alert-info text-center">Schedule some tracks to get started !</div>
        </section>

        <section t-else="" class="container" t-foreach="days" t-as="day">
            <!-- Day Title -->
            <div class="o_page_hader d-flex justify-content-between align-items-center mt0 mb-2 border-bottom border-dark">
                <h3 class="d-flex">
                    <span class="mr-2" t-esc="day.strftime('%A')"/> <span t-esc="day.day"/>
                    <div class="ml-2 d-flex flex-column" style="line-height: 0.8; font-size: 0.5em;">
                        <span class="pt-1 pb-1" t-esc="day.strftime('%B').upper()"/>
                        <span t-esc="day.year"/>
                    </div>

                </h3>
                <small class="float-right text-muted"><t t-esc="tracks_by_days[day]"/> tracks</small>
            </div>

            <!-- Day Agenda -->
            <div class="o_we_online_agenda">
            <table id="table_search" class="table table-sm border-0">
                <!--Header-->
                <tr>
                    <th class="border-0 bg-white position-sticky"/>
                    <t t-foreach="locations" t-as="location">
                        <th t-if="location" class="active text-center border-0">
                            <span t-esc="location and location.name or 'Unknown'"/>
                        </th>
                    </t>
                </tr>

                <!-- Time Slots -->
                <t t-set="used_cells" t-value="[]"/>
                <t t-foreach="time_slots[day]" t-as="time_slot">
                    <t t-set="is_round_hour" t-value="time_slot == time_slot.replace(minute=0)"/>
                    <t t-set="is_half_hour" t-value="time_slot == time_slot.replace(minute=30)"/>

                    <tr t-att-class="'%s' % ('active' if is_round_hour else '')">
                        <td class="active">
                            <b t-if="is_round_hour" t-esc="time_slots[day][time_slot]['formatted_time']"/>
                        </td>

                        <t t-foreach="locations" t-as="location">
                            <t t-set="tracks" t-value="time_slots[day][time_slot].get(location, {})"/>
                            <t t-if="tracks">
                                <t t-foreach="tracks" t-as="track">
                                    <t t-if="track.location_id and track.location_id == location">
                                        <td t-att-rowspan="tracks[track]['rowspan']"
                                            t-attf-class="text-center event_color_#{track.color} #{track and 'event_track' or ''}">
                                            <t t-call="website_event_track_online.agenda_track_content"/>
                                        </td>
                                    </t>
                                    <t t-else="">
                                        <td t-att-colspan="len(locations)-1"
                                            t-att-rowspan="tracks[track]['rowspan']"
                                            t-attf-class="text-center event_color_#{track.color} #{track and 'event_track' or ''}">
                                            <t t-call="website_event_track_online.agenda_track_content"/>
                                        </td>
                                    </t>
                                    <t t-set="used_cells" t-value="used_cells + tracks[track]['occupied_cells']"/>
                                </t>
                            </t>
                            <t t-elif="location and (time_slot, location) not in used_cells">
                                <td t-att-rowspan="1"
                                    t-att-class="'%s' % (
                                        'o_we_agenda_time_slot_half' if is_half_hour else
                                        'o_we_agenda_time_slot_main' if is_round_hour else
                                        ''
                                    )"/>
                            </t>
                        </t>
                    </tr>
                </t>
            </table>
            </div>
        </section>
        <div class="oe_structure" id="oe_structure_website_event_track_agenda_2"/>
    </t>
</template>


<template id="agenda_track_content">
    <t t-set="option_track_wishlist" t-value="not event.is_done and request.website.viewref('website_event_track_session.session_topbar_wishlist').active"/>
    <div class="d-flex flex-column h-100">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                <small t-if="track.partner_id"><i class="fa fa-user mr-2"/><t t-esc="track.partner_id.sudo().name"/></small>
                <small t-if="not track.partner_id"><i class="fa fa-user mr-2"/><t t-esc="track.partner_name"/></small>
            </div>
            <div class="d-flex">
                <small t-if="track.is_track_live and not track.is_track_done and track.website_published"
                       class="ml-1 badge badge-danger">Live</small>
                <small t-if="not track.website_published and user_event_manager and track.stage_id.is_accepted"
                       class="ml-1 badge badge-danger">Unpublished</small>
                <small t-if="not track.stage_id.is_accepted"
                       class="ml-1 badge badge-danger">Not Accepted</small>
                <span t-if="option_track_wishlist">
                    <t t-call="website_event_track_online.track_widget_reminder">
                        <t t-set="reminder_light" t-value="True"/>
                        <t t-set="reminder_small" t-value="True"/>
                    </t>
                </span>
            </div>
        </div>

        <div class="o_we_agenda_card_content d-flex flex-column justify-content-center my-1">
            <div t-att-class="'text-black' if track.website_published or user_event_manager else 'text-muted'"
                 t-att-onclick="'window.location=\'/event/%s/track/%s\'' % (slug(event), slug(track))
                    if track.website_published or user_event_manager else ''">
                <span class="text-bold" t-esc="track.name"/>
            </div>
            <div class="d-flex justify-content-center flex-wrap">
                <span t-foreach="track.tag_ids" t-as="tag"
                      t-attf-class="mr-1 mt-1 badge #{'o_tag_color_'+str(tag.color)}" t-esc="tag.name"
                      t-attf-onclick="
                        var value = '#{tag.name}' ;
                        var target = $('#event_track_search');
                        if (target.val() == value) { target.val(''); } else { target.val(value); }
                        target.trigger('input');
                      "
                />
            </div>
        </div>
    </div>
</template>

<!-- Pimp sponsor view -->
<template id="event_sponsor"
    name="Track Online: Sponsors"
    inherit_id="website_event_track.event_sponsor">
    <xpath expr="//div[@t-if='event.sponsor_ids']" position="replace">
        <div class="container mt32 mb16 d-print-none" t-if="event.sponsor_ids">
            <div t-attf-class="d-flex flex-wrap mb-5 #{'' if (len(event.sponsor_ids) > 10) else 'justify-content-md-center'}">
                <t t-foreach="event.sponsor_ids" t-as="sponsor">
                    <t t-if="sponsor.url">
                        <a class="o_wevent_sponsor_card" target="_blank" t-att-href="sponsor.url">
                            <div class="h-100 shadow-sm p-2">
                                <span t-field="sponsor.image_128"
                                    t-options='{"widget": "image", "class": "img img-fluid"}'/>
                                <div t-if="sponsor.sponsor_type_id.display_ribbon_style and sponsor.sponsor_type_id.display_ribbon_style != 'no_ribbon'" class="ribbon-wrapper">
                                    <div t-field="sponsor.sponsor_type_id" t-attf-class="ribbon ribbon_#{sponsor.sponsor_type_id.display_ribbon_style}"/>
                                </div>
                            </div>
                        </a>
                    </t>
                    <t t-if="not sponsor.url">
                        <div class="o_wevent_sponsor_card">
                            <div class="h-100 shadow-sm p-2">
                                <span t-field="sponsor.image_128"
                                    t-options='{"widget": "image", "class": "img img-fluid"}'/>
                                <div t-if="sponsor.sponsor_type_id.display_ribbon_style and sponsor.sponsor_type_id.display_ribbon_style != 'no_ribbon'" class="ribbon-wrapper">
                                    <div t-field="sponsor.sponsor_type_id" t-attf-class="ribbon ribbon_#{sponsor.sponsor_type_id.display_ribbon_style}"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
            </div>
        </div>
    </xpath>
</template>

</odoo>
